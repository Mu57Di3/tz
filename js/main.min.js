!function t(e,a,n){function i(o,c){if(!a[o]){if(!e[o]){var l="function"==typeof require&&require;if(!c&&l)return l(o,!0);if(s)return s(o,!0);var r=new Error("Cannot find module '"+o+"'");throw r.code="MODULE_NOT_FOUND",r}var h=a[o]={exports:{}};e[o][0].call(h.exports,function(t){var a=e[o][1][t];return i(a?a:t)},h,h.exports,t,e,a,n)}return a[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(t,e,a){var n=Marionette.Application.extend({el:"body",ImagesCollection:null,MainView:null,initialize:function(){},events:{"click button#bNew":"newImageHandler"}}),i=Backbone.Marionette.LayoutView.extend({template:"templates/main.twig",regions:{main:"#app",modal:"#modal"},events:{"click button#bNew":"newImageHandler"},onShow:function(){var e=t("./ctrl/imagelist");app.ImagesCollection=t("./model/images"),app.ImagesCollection.fetch(),this.getRegion("main").show(new e({collection:app.ImagesCollection}))},newImageHandler:function(){var e=t("./ctrl/popup"),a=t("./ctrl/editor");this.getRegion("modal").show(new e({v:new a,tpl:{title:"Новое изображение",button:""},success:!1}))}});app=new n,app.addRegions({app:".container"}),app.on("start",function(){this.MainView=new i,this.getRegion("app").show(this.MainView)}),app.start()},{"./ctrl/editor":2,"./ctrl/imagelist":3,"./ctrl/popup":4,"./model/images":5}],2:[function(t,e,a){var n=Backbone.Marionette.ItemView.extend({template:"templates/editor.twig",canvasContext:null,clickX:[],clickY:[],clickDrag:[],paint:!1,appContext:null,edit_key:null,name:null,outlineImage:null,initialize:function(t){t.name&&(this.name=t.name),t.edit_key&&(this.edit_key=t.edit_key)},events:{"click button#bClear":"clearHandler","click button#bSave":"saveHandler","mousedown #dSpace":"canvasMouseDownHandler","mousemove #dSpace":"canvasMouseMoveHandler","mouseup #dSpace":"offPaintHandler","mouseleave #dSpace":"offPaintHandler"},onRender:function(){var t=this.$("div#cWrapper"),e=document.createElement("canvas");e.setAttribute("width",600),e.setAttribute("height",400),e.setAttribute("id","dSpace"),t.append(e),"undefined"!=typeof G_vmlCanvasManager&&(e=G_vmlCanvasManager.initElement(e)),this.canvasContext=e.getContext("2d"),this.clickX=[],this.clickY=[],this.clickDrag=[],this.canvasContext.fillStyle="#ffffff",this.canvasContext.fillRect(0,0,this.canvasContext.canvas.width,this.canvasContext.canvas.height),this.outlineImage=null,null!=this.name&&(this.outlineImage=new Image,this.outlineImage.src="http://tz.mu57di3.org/img/full/"+this.name+".jpg",this.canvasContext.drawImage(this.outlineImage,0,0,this.canvasContext.canvas.width,this.canvasContext.canvas.height))},clearHandler:function(){this.canvasContext.clearRect(0,0,this.canvasContext.canvas.width,this.canvasContext.canvas.height),this.clickX=[],this.clickY=[],this.clickDrag=[],this.canvasContext.fillStyle="#ffffff",this.canvasContext.fillRect(0,0,this.canvasContext.canvas.width,this.canvasContext.canvas.height)},saveHandler:function(){var t=this.canvasContext.canvas.toDataURL("image/jpeg",1),e={newimage:t};null!=this.name&&null!=this.edit_key&&(e.edit_key=this.edit_key,e.name=this.name);var a=this;$.ajax({url:"http://tz.mu57di3.org/imagehole",dataType:"json",type:"POST",data:e}).success(function(t){if("ok"==t.status)if(null===a.name&&null===a.edit_key){app.ImagesCollection.addNewImage({name:t.data.name,ts:t.data.ts});var e=a.$("#pEditKey");e.text("Коюч редактирования: "+t.data.edit_key),e.show()}else app.ImagesCollection.setImage({name:t.data.name,ts:t.data.ts})}).error(function(t){})},canvasMouseDownHandler:function(t){this.paint=!0;var e=this.canvasContext.canvas.getBoundingClientRect();this.addClick(t.clientX-e.left,t.clientY-e.top,!1),this.redraw()},canvasMouseMoveHandler:function(t){if(this.paint){var e=this.canvasContext.canvas.getBoundingClientRect();this.addClick(t.clientX-e.left,t.clientY-e.top,!0),this.redraw()}},offPaintHandler:function(t){this.paint=!1},addClick:function(t,e,a){this.clickX.push(t),this.clickY.push(e),this.clickDrag.push(a)},redraw:function(){this.canvasContext.clearRect(0,0,this.canvasContext.canvas.width,this.canvasContext.canvas.height),this.canvasContext.strokeStyle="#000000",this.canvasContext.lineJoin="round",this.canvasContext.lineWidth=5,this.canvasContext.fillStyle="#ffffff",null!=this.outlineImage?this.canvasContext.drawImage(this.outlineImage,0,0,this.canvasContext.canvas.width,this.canvasContext.canvas.height):this.canvasContext.fillRect(0,0,this.canvasContext.canvas.width,this.canvasContext.canvas.height);for(var t=0;t<this.clickX.length;t++)this.canvasContext.beginPath(),this.clickDrag[t]&&t?this.canvasContext.moveTo(this.clickX[t-1],this.clickY[t-1]):this.canvasContext.moveTo(this.clickX[t]-1,this.clickY[t]),this.canvasContext.lineTo(this.clickX[t],this.clickY[t]),this.canvasContext.closePath(),this.canvasContext.stroke()}});e.exports=n},{}],3:[function(t,e,a){var n=Marionette.ItemView.extend({tagName:"tr",template:"templates/image.twig",events:{"click #bDelete":"removeImage","click #bEdit":"editImage"},onBeforeRender:function(){this.templateHelpers={},this.templateHelpers=this.model.attributes},removeImage:function(){var t=this.model.get("name"),e=prompt("Введите ключ редактирования данного изображения");if(null!=e&&e.length>0){var a={name:t,edit_key:e};$.ajax({url:"http://tz.mu57di3.org/delImage",dataType:"json",type:"GET",data:a}).success(function(e){"ok"==e.status?app.ImagesCollection.delImage(t):alert("Неправильный ключ редактирования")}).error(function(t){})}},editImage:function(){var e=this.model.get("name"),a=prompt("Введите ключ редактирования данного изображения");if(null!=a&&a.length>0){var n={name:e,edit_key:a};$.ajax({url:"http://tz.mu57di3.org/checkkey",dataType:"json",type:"GET",data:n}).success(function(n){if("ok"==n.status){var i=t("./popup"),s=t("./editor");app.MainView.getRegion("modal").show(new i({v:new s({name:e,edit_key:a}),tpl:{title:"Редактирование изображения "+e,button:""},success:!1}))}else alert("Неправильный ключ редактирования")}).error(function(t){})}}}),i=Marionette.CollectionView.extend({tagName:"table",childView:n,className:"table table-striped",onShow:function(){}});e.exports=i},{"./editor":2,"./popup":4}],4:[function(t,e,a){var n=Backbone.Marionette.LayoutView.extend({template:"templates/popup.twig",templateHelpers:{},events:{"click #bSuccess":"do_some"},regions:{content:"#ppContent"},initialize:function(t){t&&(t.success&&(this.success_handler=t.success),t.v&&(this.v=t.v),t.tpl&&(this.templateHelpers=t.tpl))},onShow:function(){var t=this;this.v&&this.getRegion("content").show(this.v),$("#myModal").modal("show"),$("#myModal").on("hide.bs.modal",function(e){t.remove()})},do_some:function(){this.success_handler&&this.success_handler.call(this.v)}});e.exports=n},{}],5:[function(t,e,a){var n=Backbone.Model.extend({defaults:{name:"",ts:0},idAttribute:"name"}),i=Backbone.Collection.extend({model:n,fetch:function(){var t=this;$.ajax({url:"http://tz.mu57di3.org/getImageList",dataType:"json",type:"GET"}).success(function(e){if("ok"==e.status&&e.data.length>0)for(var a=0,i=e.data.length;i>a;a++)t.add(new n(e.data[a]))}).error(function(t){})},addNewImage:function(t){this.add(new n(t))},delImage:function(t){this.remove(this.get(t))},setImage:function(t){var e=this.get(t.name);e.set(t),this.set(e,{remove:!1})}});e.exports=new i},{}]},{},[1]);